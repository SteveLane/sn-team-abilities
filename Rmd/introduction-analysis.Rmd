---
title: Introduction Analysis
---

<!-- Time-stamp: <2018-04-18 21:41:56 (slane)> -->

```{r setup,echo=FALSE,warning=FALSE,message=FALSE,cache=FALSE,results="hide"}
knitr::opts_chunk$set(cache = FALSE, error = FALSE, warning = FALSE,
                      message = FALSE, echo = TRUE, out.width = "900px",
                      out.height = "506px", dpi = 180, fig.align = "center",
                      fig.asp = 9/16, cache.path = "intro_cache/",
                      fig.path = "img/intro-2018/")
options(digits = 2)

```

# Introduction

This document provides notes on setting up my super netball score prediction model using my new `superNetballR` package. It outputs figures etc that can then be used in a blog posting.

The following packages are required:

```{r libraries}
library(dplyr)
library(tidyr)
library(purrr)
library(superNetballR)
library(rstan)
library(parallel)
library(here)
library(ggplot2)
rstan::rstan_options(auto_write = TRUE)
cores <- round(parallel::detectCores() - 2)
options(mc.cores = cores)
source(here("R", "ggsteve.R"))
theme_set(theme_steve(base_size = 20))

```

We load the model and data:

```{r load-model-data}
model <- stan_model(here("stan", "basic-model.stan"))
data(season_2017)

```

Now, we need to transform the data into a suitable format for our model. We can use the `superNetballR::matchResults` function for this:

```{r data-munging}
model_data <- season_2017 %>%
    matchResults() %>%
    select(-goals, -squadId, -squadNickname, -squadCode, -points)

```

Next, we need to be able to have the home team, away team, and score difference on a single row for stan:

```{r data-munging-stan}
spreadGame <- function(df) {
    home <- df %>%
        filter(isHome == 1) %>%
        rename(homeTeam = squadName) %>%
        select(-isHome)
    away <- df %>%
        filter(isHome == 0) %>%
        rename(awayTeam = squadName) %>%
        select(awayTeam)
    df <- bind_cols(home, away)
    df
}
model_data <- model_data %>%
    group_by(round, game) %>%
    nest() %>%
    group_by(round, game) %>%
    mutate(game_results = map(data, spreadGame)) %>%
    select(-data) %>%
    unnest()

```

Now a lookup table for teams, as that's required for stan as well. I also need to feed in the first match of the 2018 season for predictions.

```{r lookup-table}
teamLookup <- data_frame(
    squadName = sort(unique(model_data$homeTeam)),
    squadInt = seq_len(length(squadName))
)
model_data <- left_join(model_data, teamLookup,
                        by = c("homeTeam" = "squadName")) %>%
    rename(homeInt = squadInt) %>%
    left_join(., teamLookup, by = c("awayTeam" = "squadName")) %>%
    rename(awayInt = squadInt)
round1_2018 <- data_frame(
    homeSquad = c(4, 1, 2, 5),
    awaySquad = c(3, 8, 7, 6)) %>%
    left_join(., teamLookup, by = c("homeSquad" = "squadInt")) %>%
    rename(homeTeam = squadName) %>%
    left_join(., teamLookup, by = c("awaySquad" = "squadInt")) %>%
    rename(awayTeam = squadName)
stan_data <- with(
    model_data, list(nteams = max(homeInt), ngames = nrow(model_data),
                     nrounds = max(round), round_no = round, home = homeInt,
                     away = awayInt, score_diff = score_diff,
                     init_ability = rep(0, max(homeInt)),
                     init_sd = rep(1, max(homeInt)), ngames_pred = 4,
                     pred_home = round1_2018$homeSquad,
                     pred_away = round1_2018$awaySquad))

```

Now I can run it:

```{r stan-model,cache=TRUE}
output <- sampling(
    model,
    data = stan_data,
    iter = 2000,
    chains = cores,
    open_progress = FALSE,
    control = list(adapt_delta = 0.9,
                   max_treedepth = 10)
)
print(output, digits = 1, pars = c("hga", paste0("a[14,", 1:8, "]")))
print(output, digits = 1, pars = c("pred_ability", "pred_diff", "prob_home"))

```

# Summaries

Now I need to create some summaries. As a highlight, perhaps a histogram of score differences for each game, and the probability of the home team winning.

```{r histogram}
predDiffHist <- function(model, round, game, game_lookup, outname) {
    home <- toupper(game_lookup$homeTeam[game])
    away <- toupper(game_lookup$awayTeam[game])
    pred_diff <- extract(model, paste0("pred_diff[", game, "]"))[[1]] %>%
        as_data_frame()
    prob <- extract(model, paste0("prob_home[", game, "]"))[[1]]
    prob <- round(mean(prob) * 100)
    title_text <- paste0(home, " v.s. ", away)
    subtitle_text <- paste0("Chance of ", home, " winning: ", prob, "%")
    pl_diff <- ggplot(pred_diff, aes(x = value)) +
        geom_histogram() +
        xlab("Score differential") +
        ylab("") +
        ggtitle(title_text, subtitle_text)
    ## Create an appropriate file to save ? Or just print the object?
}

```
